name: Deploy

on:
  push:
    branches: ["main"]

concurrency:
  group: medusa-deploy-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: write
  packages: write
  deployments: write

env:
  NODE_VERSION: 20
  PNPM_VERSION: 10.18.2

jobs:
  detect-changes:
    name: Detect changes
    runs-on: ubuntu-latest
    outputs:
      medusa: ${{ steps.changes.outputs.medusa }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - id: changes
        uses: dorny/paths-filter@v3
        with:
          base: ${{ github.event.before || 'HEAD^' }}
          filters: |
            medusa:
              - "apps/medusa/**"
              - "packages/**"
              - "package.json"
              - "pnpm-lock.yaml"
              - "pnpm-workspace.yaml"
              - "turbo.json"
              - 'render.yaml'
              - ".github/workflows/**"

  build:
    needs: detect-changes
    if: needs.detect-changes.outputs.medusa == 'true'
    name: Build Docker image
    uses: ./.github/workflows/_build-docker.yaml
    with:
      app: medusa
      dockerfile: ./apps/medusa/Dockerfile

  deploy-smoke:
    name: Deploy to Smoke
    needs: build
    uses: ./.github/workflows/_deploy-render.yaml
    with:
      environment_name: smoke
      deploy_label: Smoke
      service_name: gfed-medusa-be-smoke
      image: ${{ needs.build.outputs.image_tag }}
    secrets:
      RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}

  deploy-qa:
    name: Deploy to QA
    needs: [build, deploy-smoke]
    uses: ./.github/workflows/_deploy-render.yaml
    with:
      environment_name: qa
      deploy_label: QA
      service_name: gfed-medusa-be-qa
      image: ${{ needs.build.outputs.image_tag }}
    secrets:
      RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}

  deploy-prod:
    name: Deploy to Production
    needs: [build, deploy-qa]
    uses: ./.github/workflows/_deploy-render.yaml
    with:
      environment_name: production
      deploy_label: Production
      service_name: gfed-medusa-be
      image: ${{ needs.build.outputs.image_tag }}
    secrets:
      RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}

  promote-latest:
    name: Promote deployed image to latest
    needs: [build, deploy-prod]
    if: needs.deploy-prod.result == 'success'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Promote SHA image to latest
        env:
          SOURCE_IMAGE: ${{ needs.build.outputs.image_tag }}
          TARGET_IMAGE: ghcr.io/${{ github.repository }}/medusa:latest
        run: |
          set -euo pipefail
          docker pull "$SOURCE_IMAGE"
          docker tag "$SOURCE_IMAGE" "$TARGET_IMAGE"
          docker push "$TARGET_IMAGE"
          echo "Promoted $SOURCE_IMAGE to $TARGET_IMAGE"

  create-tags:
    name: Create production tags
    needs: [detect-changes, build, deploy-smoke, deploy-qa, deploy-prod, promote-latest]
    if: |
      always() &&
      needs.deploy-prod.result == 'success' &&
      needs.promote-latest.result == 'success'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Read service version
        id: version
        run: |
          MEDUSA_VERSION=$(jq -r '.version' apps/medusa/package.json)

          if [ -z "$MEDUSA_VERSION" ] || [ "$MEDUSA_VERSION" = "null" ]; then
            echo "::error::Invalid version in medusa package.json: '$MEDUSA_VERSION'"
            exit 1
          fi

          if ! echo "$MEDUSA_VERSION" | grep -Eq '^[0-9]+\.[0-9]+\.[0-9]+'; then
            echo "::error::Version '$MEDUSA_VERSION' for medusa is not valid semver (must be X.Y.Z)"
            exit 1
          fi

          echo "medusa=$MEDUSA_VERSION" >> "$GITHUB_OUTPUT"

      - name: Create git tag for deployed service
        env:
          MEDUSA_VERSION: ${{ steps.version.outputs.medusa }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          VERSION="$MEDUSA_VERSION"
          TAG="medusa@$VERSION"

          if ! git rev-parse "$TAG" >/dev/null 2>&1; then
            git tag -a "$TAG" -m "Production release $TAG"

            if git push origin "$TAG"; then
              echo "✓ Created tag: $TAG"
            else
              echo "::error::Failed to push tag: $TAG"
              exit 1
            fi
          else
            TAG_COMMIT=$(git rev-list -n 1 "$TAG" 2>/dev/null)
            CURRENT_COMMIT=$(git rev-parse HEAD)

            if [ "$TAG_COMMIT" = "$CURRENT_COMMIT" ]; then
              echo "⚠ Tag $TAG already exists for this commit (idempotent deployment)"
            else
              echo "::error::Tag $TAG already exists but points to different commit"
              echo "::error::Current commit: $CURRENT_COMMIT"
              echo "::error::Tag points to:  $TAG_COMMIT"
              echo "::error::Please bump the version in apps/medusa/package.json before deploying"
              exit 1
            fi
          fi
